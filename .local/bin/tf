#!/usr/bin/env bash
set -o pipefail
set -o errexit
if [ "${TRACE-0}" == "1" ]; then
	set -o xtrace
fi


# This utility saves every Terraform plan locally. If you want to apply it
# checks if it can find a recent plan. When found it will apply said plan.
# Otherwise it's going to execute the plan.
case "$1" in
plan)
	shift
	terraform plan -out tfplan "$@"
	;;
apply)
	shift
	if test "$(find "tfplan" -maxdepth 1 -mmin -2)"; then # If a plan exists of less than a minute old, execute it
		echo "Found a recent plan to execute"
		terraform show tfplan
		read -rp "Are you sure? [y/N]" -n 1
		case $REPLY in
		y | Y) terraform apply tfplan "$@" && rm tfplan ;;
		n | N) exit ;;
		esac
	else
		test -f tfplan && rm tfplan
		terraform apply "$@"
	fi
	;;
*)
	terraform "$@"
	;;
esac
