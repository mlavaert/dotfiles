#!/usr/bin/env bash
set -o pipefail
set -o errexit
if [ "${TRACE-0}" == "1" ]; then
	set -o xtrace
fi

# Create a checksum of the arguments and all files in the Terraform module
CHECKSUM=$(echo "${@:2}" "$(sha1sum $(find . -maxdepth 1 -type f) | sha1sum)" | sha1sum | cut -d ' ' -f 1)
PLAN="${XDG_CACHE_HOME}/terraform/$CHECKSUM.tfplan"

echo "Checksum: $CHECKSUM"

# This utility saves every Terraform plan locally. If you want to apply it
# checks if it can find a recent plan. When found it will apply said plan.
# Otherwise it's going to execute the plan.
case "$1" in
fmt)
	shift
	terraform fmt -recursive # Always format recursively
	;;
plan)
	shift
	terraform plan -out "$PLAN" "$@"
	;;
apply)
	shift
	if test -f "${PLAN}"; then # If a plan exists of less than a minute old, execute it
		echo "üìç Found a plan to execute"
		trap  'rm ${PLAN}' EXIT
		terraform apply "${PLAN}" "$@"
	else
		terraform apply "$@"
	fi
	;;
*)
	terraform "$@"
	;;
esac
