#!/usr/bin/env sh

# Provides a simple way to get secrets from AWS Parameter Store and securely
# cache them locally using GNU Pass

if ! gopass "$1"; then
  secret="$(aws ssm get-parameter \
    --name "$1" \
    --no-verify-ssl \
    --with-decryption \
    --output text \
    --query Parameter.Value 2>/dev/null)"

  if test -z "$secret"; then
    echo "Could not retrieve the secret from AWS"
    exit 1
  fi

  echo "$secret" | gopass insert "$1"
  echo "$secret"
fi
